function debounce(t,e=300){let a;return function(...o){clearTimeout(a),a=setTimeout((()=>{t.apply(this,o)}),e)}}let animadores={},pjDonutChart=null;function initAnimadores(){const t={duration:.8,useEasing:!0,decimal:",",separator:".",prefix:"R$ "},e={"res-pj-liquido":t,"res-pj-impostos":{...t,prefix:"-R$ "}};try{if(!("undefined"!=typeof countUp))return void console.error("ERRO CRÍTICO: Biblioteca CountUp.js não carregou a tempo!");for(const t in e){const a=document.getElementById(t);a?(animadores[t]=new countUp.CountUp(a,0,e[t]),animadores[t].error?console.error(`Erro ao criar animador para #${t}:`,animadores[t].error):animadores[t].start()):console.warn(`Elemento #${t} não encontrado.`)}}catch(t){console.error("Erro fatal no initAnimadores:",t)}}const formatadorBRL=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}),SALARIO_MINIMO=1518,TETO_INSS=8157.41,FAIXAS_INSS=[{teto:1518,aliquota:.075,deduzir:0},{teto:2793.88,aliquota:.09,deduzir:22.77},{teto:4190.83,aliquota:.12,deduzir:106.59},{teto:8157.41,aliquota:.14,deduzir:190.42}],INSS_TETO=TETO_INSS*FAIXAS_INSS[3].aliquota-FAIXAS_INSS[3].deduzir,FAIXAS_IRRF=[{limite:2428.8,aliquota:0,deducao:0},{limite:2826.65,aliquota:.075,deducao:182.16},{limite:3751.05,aliquota:.15,deducao:409.71},{limite:4664.68,aliquota:.225,deducao:682.81},{limite:1/0,aliquota:.275,deducao:912.91}],DEDUCAO_DEPENDENTE_IRRF=189.59,ANEXO_III=[{teto:18e4,aliquota:.06,pd:0},{teto:36e4,aliquota:.112,pd:9360},{teto:72e4,aliquota:.135,pd:17640},{teto:18e5,aliquota:.16,pd:35640},{teto:36e5,aliquota:.21,pd:125640},{teto:48e5,aliquota:.33,pd:648e3}],ANEXO_V=[{teto:18e4,aliquota:.155,pd:0},{teto:36e4,aliquota:.18,pd:4500},{teto:72e4,aliquota:.195,pd:9900},{teto:18e5,aliquota:.205,pd:17100},{teto:36e5,aliquota:.23,pd:62100},{teto:48e5,aliquota:.305,pd:54e4}];function criarTaxItem(t,e,a,o="desconto",n="da receita"){const r=document.createElement("div");r.className="tax-item","provento"===o&&r.classList.add("provento");const i=document.createElement("span"),l=document.createElement("span");l.className="percentage",l.textContent=`(${(100*a).toFixed(1)}% ${n})`.replace(".",","),i.append(t,l);const s=document.createElement("strong");return s.textContent=`${"provento"===o?"+":"-"}${formatBRL(e)}`,r.append(i,s),r}function criarTaxItemTotal(t,e,a="desconto"){const o=document.createElement("div");o.className="tax-item tax-item-total","provento"===a&&o.classList.add("provento");const n=document.createElement("span");n.textContent=t;const r=document.createElement("strong");return r.textContent=`${"provento"===a?"+":"-"}${formatBRL(e)}`,o.append(n,r),o}const formatBRL=t=>formatadorBRL.format(t||0),getFloat=t=>parseFloat(document.getElementById(t).value)||0,getString=t=>document.getElementById(t).value||"";function calcularIRRF_PelaTabela(t,e=0){if(t<=0)return 0;const a=(e||0)*DEDUCAO_DEPENDENTE_IRRF,o=Math.max(0,t-a);for(const t of FAIXAS_IRRF)if(o<=t.limite)return Math.max(0,o*t.aliquota-t.deducao);const n=FAIXAS_IRRF[FAIXAS_IRRF.length-1];return Math.max(0,o*n.aliquota-n.deducao)}function calcularAliquotaEfetiva(t,e){if(t<=0)return 0;let a=e[e.length-1];for(const o of e)if(t<=o.teto){a=o;break}const{aliquota:o,pd:n}=a,r=(t*o-n)/t;return r>0?r:0}function calcularCustosPJ(t,e,a,o){const n=calcularAliquotaEfetiva(e,o),r=t*n,i=Math.min(.11*a,.11*TETO_INSS),l=calcularIRRF_PelaTabela(a-i,0);return{totalCustos:r+i+l,das:r,inss:i,irrf:l,aliquotaEfetiva:n}}function calcularSalarioPJ(){const t=getFloat("pj-faturamento");let e=getFloat("pj-rbt12");const a=getString("pj-atividade"),o=getFloat("pj-contabilidade"),n=getFloat("pj-outros");let r,i,l,s,d,u,c;if(e<=0&&(e=12*t),t<=0)return{valorFinal:0,totalImpostos:0,aliquotaEfetiva:0,titulo:"PJ",detalhesImpostos:[],prolabore:0,estrategia:"Preencha os dados"};if("anexo_iii"===a){r=Math.min(t,Math.max(SALARIO_MINIMO,.01*t)),i="iii";const a=calcularCustosPJ(t,e,r,ANEXO_III);l=a.aliquotaEfetiva,s=a.das,d=a.inss,u=a.irrf,c=`Pró-labore mínimo (R$ ${formatBRL(r)}) para Anexo III Direto.`}else{const a=Math.min(t,Math.max(SALARIO_MINIMO,.28*t)),p=a/(t||1)>=.28?"iii":"v",m=calcularCustosPJ(t,e,a,a/(t||1)>=.28?ANEXO_III:ANEXO_V),I=m.totalCustos+o+n,E=Math.min(t,SALARIO_MINIMO),f=calcularCustosPJ(t,e,E,ANEXO_V);I<f.totalCustos+o+n?(r=a,i=p,l=m.aliquotaEfetiva,s=m.das,d=m.inss,u=m.irrf,c=`Pró-labore de 28% (R$ ${formatBRL(r)}) para otimizar o Fator R e tributar no Anexo III.`):(r=E,i="v",l=f.aliquotaEfetiva,s=f.das,d=f.inss,u=f.irrf,c=`Pró-labore Mínimo (R$ ${formatBRL(r)}) para evitar IRRF alto, aceitando o Anexo V. (Estratégia do "Ponto de Virada")`)}const p=s+d+u+o+n,m=t-p,I=[];return s>0&&I.push({nome:`Simples (Alíq. Efetiva ${i.toUpperCase()})`,valor:s,percentual:l,tipo:"desconto"}),d>0&&I.push({nome:"INSS Pró-labore",valor:d,percentual:d/(t||1),tipo:"desconto"}),u>0&&I.push({nome:"IRRF Pró-labore",valor:u,percentual:u/(t||1),tipo:"desconto"}),o>0&&I.push({nome:"Contabilidade",valor:o,percentual:o/(t||1),tipo:"desconto"}),n>0&&I.push({nome:"Outros Custos",valor:n,percentual:n/(t||1),tipo:"desconto"}),{valorFinal:Math.max(0,m),totalImpostos:p,titulo:`Simples ${i.toUpperCase()}`,aliquotaEfetiva:t>0?p/t:0,detalhesImpostos:I,prolabore:r,estrategia:c}}function atualizarUI(){try{const t=calcularSalarioPJ();animadores["res-pj-liquido"]&&animadores["res-pj-liquido"].update(t.valorFinal),animadores["res-pj-impostos"]&&animadores["res-pj-impostos"].update(t.totalImpostos);const e=document.getElementById("res-pj-aliquota");e&&(e.textContent=`${(100*t.aliquotaEfetiva).toFixed(1)}% da receita`.replace(".",",")),atualizarDonutCharts(t.valorFinal,t.totalImpostos);const a=document.getElementById("pj-prolabore-calculado"),o=document.getElementById("pj-prolabore-calculado-wrapper");a&&o&&(t.prolabore>0?(a.value=(t.prolabore||0).toFixed(2).replace(".",","),o.style.display="block"):(a.value="0,00",o.style.display="none"));const n=document.getElementById("pj-strategy-text"),r=document.getElementById("pj-strategy-box");n&&r&&(t.estrategia&&"Preencha os dados"!==t.estrategia?(n.textContent=t.estrategia,r.style.display="block"):r.style.display="none");const i=document.getElementById("pj-detalhe-titulo");i&&(i.textContent=`Detalhes (${t.titulo||"Simples"})`);const l=document.getElementById("tax-details-pj");if(l){l.textContent="";let e=0;t.detalhesImpostos.length>0?(t.detalhesImpostos.forEach((t=>{t.valor>0&&(l.appendChild(criarTaxItem(t.nome,t.valor,t.percentual,"desconto","da receita")),e+=t.valor)})),l.appendChild(criarTaxItemTotal(`Total de Custos ${t.titulo}`,e,"desconto"))):l.innerHTML='<div class="tax-item"><span>Preencha os dados</span></div>'}atualizarAlturasAccordions()}catch(t){console.error("Erro DENTRO de atualizarUI:",t)}}function criarOuAtualizarDonut(t,e,a,o,n){const r=document.getElementById(e);if(!r)return null;const i=[],l=[],s=[];o.forEach(((t,e)=>{t>0&&(i.push(t),l.push(a[e]),s.push(n[e]))})),0===i.length&&(i.push(1),l.push("Nenhum dado"),s.push("#3A3052"));const d={labels:l,datasets:[{data:i,backgroundColor:s,borderColor:"rgba(33, 28, 48, 0.5)",borderWidth:2,hoverOffset:4}]},u={type:"doughnut",data:d,options:{responsive:!0,maintainAspectRatio:!0,cutout:"70%",plugins:{legend:{display:!0,position:"bottom",labels:{color:"#A09CB0",font:{family:"Poppins"},padding:10}},tooltip:{callbacks:{label:function(t){const e=t.label||"",a=t.raw||0,o=t.chart.data.datasets[0].data.reduce(((t,e)=>t+e),0),n=o>0?(a/o*100).toFixed(1):0;return"Nenhum dado"===e?"Nenhum dado":` ${e}: ${formatBRL(a)} (${n.replace(".",",")}%)`}}}}}};return t?(t.data=d,t.update(),t):new Chart(r,u)}function atualizarDonutCharts(t,e){pjDonutChart=criarOuAtualizarDonut(pjDonutChart,"pj-donut-chart",["Líquido no Bolso","Total de Custos/Impostos"],[t,e],["#98c379","#E06C75"])}function atualizarAlturasAccordions(){document.querySelectorAll(".accordion-content").forEach((t=>{const e=t.previousElementSibling;e&&e.classList.contains("active")&&(t.style.maxHeight=t.scrollHeight+"px")}))}if("undefined"!=typeof window){const t=debounce(atualizarUI,300),e=atualizarUI;document.addEventListener("DOMContentLoaded",(()=>{["pj-faturamento","pj-rbt12","pj-atividade","pj-contabilidade","pj-outros"].forEach((a=>{const o=document.getElementById(a);if(o){"change"===("SELECT"===o.tagName?"change":"input")?o.addEventListener("change",e):o.addEventListener("input",t)}}));document.querySelectorAll(".accordion-button").forEach((t=>{t.addEventListener("click",(()=>{t.classList.toggle("active");const e=t.nextElementSibling;e.style.maxHeight?e.style.maxHeight=null:e.style.maxHeight=e.scrollHeight+"px"}))}))})),window.addEventListener("load",(()=>{try{initAnimadores(),atualizarUI()}catch(t){console.error("Erro durante o window.onload:",t)}}))}