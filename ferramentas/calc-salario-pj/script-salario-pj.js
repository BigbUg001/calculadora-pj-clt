let animadores={},pjDonutChart=null;function initAnimadores(){const t={duration:.8,useEasing:!0,decimal:",",separator:".",prefix:"R$ "},a={"res-pj-liquido":t,"res-pj-impostos":{...t,prefix:"-R$ "}};try{if("undefined"==typeof countUp)return void console.error("ERRO CRÍTICO: Biblioteca CountUp.js não carregou a tempo!");for(const t in a){const o=document.getElementById(t);o?(animadores[t]=new countUp.CountUp(o,0,a[t]),animadores[t].error?console.error(`Erro ao criar animador para #${t}:`,animadores[t].error):animadores[t].start()):console.warn(`Elemento #${t} não encontrado.`)}}catch(t){console.error("Erro fatal no initAnimadores:",t)}}function calcularCustosPJ(t,a,o,e){const n=calcularAliquotaEfetiva(a,e),r=t*n,i=Math.min(.11*o,.11*TETO_INSS),s=calcularIRRF_PelaTabela(o-i,0);return{totalCustos:r+i+s,das:r,inss:i,irrf:s,aliquotaEfetiva:n}}const INPUT_LIMITS_PJ={"pj-faturamento":4e5,"pj-rbt12":48e5,"pj-contabilidade":99999,"pj-outros":999999};function calcularSalarioPJ(){const t=Math.min(getFloat("pj-faturamento"),INPUT_LIMITS_PJ["pj-faturamento"]);let a=getFloat("pj-rbt12");const o=getString("pj-atividade"),e=Math.min(getFloat("pj-contabilidade"),INPUT_LIMITS_PJ["pj-contabilidade"]),n=Math.min(getFloat("pj-outros"),INPUT_LIMITS_PJ["pj-outros"]);let r,i,s,l,d,c,u;if(a<=0&&(a=12*t),a=Math.min(a,INPUT_LIMITS_PJ["pj-rbt12"]),t<=0)return{valorFinal:0,totalImpostos:0,aliquotaEfetiva:0,titulo:"PJ",detalhesImpostos:[],prolabore:0,estrategia:"Preencha os dados"};if("anexo_iii"===o){r=Math.min(t,Math.max(SALARIO_MINIMO,.01*t)),i="iii";const o=calcularCustosPJ(t,a,r,ANEXO_III);s=o.aliquotaEfetiva,l=o.das,d=o.inss,c=o.irrf,u=`Pró-labore mínimo (${formatBRL(r)}) para Anexo III Direto.`}else{const o=Math.min(t,Math.max(SALARIO_MINIMO,.28*t)),p=o/(t||1)>=.28?"iii":"v",m=calcularCustosPJ(t,a,o,o/(t||1)>=.28?ANEXO_III:ANEXO_V),I=m.totalCustos+e+n,h=Math.min(t,SALARIO_MINIMO),f=calcularCustosPJ(t,a,h,ANEXO_V);I<f.totalCustos+e+n?(r=o,i=p,s=m.aliquotaEfetiva,l=m.das,d=m.inss,c=m.irrf,u=`Pró-labore de 28% (R$ ${formatBRL(r)}) para otimizar o Fator R e tributar no Anexo III.`):(r=h,i="v",s=f.aliquotaEfetiva,l=f.das,d=f.inss,c=f.irrf,u=`Pró-labore Mínimo (R$ ${formatBRL(r)}) para evitar IRRF alto, aceitando o Anexo V. (Estratégia do "Ponto de Virada")`)}const p=l+d+c+e+n,m=t-p,I=[];return l>0&&I.push({nome:`Simples (Alíq. Efetiva ${i.toUpperCase()})`,valor:l,percentual:s,tipo:"desconto"}),d>0&&I.push({nome:"INSS Pró-labore",valor:d,percentual:d/(t||1),tipo:"desconto"}),c>0&&I.push({nome:"IRRF Pró-labore",valor:c,percentual:c/(t||1),tipo:"desconto"}),e>0&&I.push({nome:"Contabilidade",valor:e,percentual:e/(t||1),tipo:"desconto"}),n>0&&I.push({nome:"Outros Custos",valor:n,percentual:n/(t||1),tipo:"desconto"}),{valorFinal:Math.max(0,m),totalImpostos:p,titulo:`Simples ${i.toUpperCase()}`,aliquotaEfetiva:t>0?p/t:0,detalhesImpostos:I,prolabore:r,estrategia:u}}function atualizarUI(){try{const t=calcularSalarioPJ();animadores["res-pj-liquido"]&&animadores["res-pj-liquido"].update(t.valorFinal),animadores["res-pj-impostos"]&&animadores["res-pj-impostos"].update(t.totalImpostos);const a=document.getElementById("res-pj-aliquota");a&&(a.textContent=`${(100*t.aliquotaEfetiva).toFixed(1)}% da receita`.replace(".",",")),atualizarDonutCharts(t.valorFinal,t.totalImpostos);const o=document.getElementById("pj-prolabore-calculado"),e=document.getElementById("pj-prolabore-calculado-wrapper");o&&e&&(t.prolabore>0?(o.value=(t.prolabore||0).toFixed(2).replace(".",","),e.style.display="block"):(o.value="0,00",e.style.display="none"));const n=document.getElementById("pj-strategy-text"),r=document.getElementById("pj-strategy-box");n&&r&&(t.estrategia&&"Preencha os dados"!==t.estrategia?(n.textContent=t.estrategia,r.style.display="block"):r.style.display="none");const i=document.getElementById("pj-detalhe-titulo");i&&(i.textContent="Detalhes PJ");const s=document.getElementById("tax-details-pj");if(s){s.textContent="";let a=0;t.detalhesImpostos.length>0?(t.detalhesImpostos.forEach((t=>{t.valor>0&&(s.appendChild(criarTaxItem(t.nome,t.valor,t.percentual,"desconto","da receita")),a+=t.valor)})),s.appendChild(criarTaxItemTotal(`Total de Custos ${t.titulo}`,a,"desconto"))):s.innerHTML='<div class="tax-item"><span>Preencha os dados</span></div>'}atualizarAlturasAccordions()}catch(t){console.error("Erro DENTRO de atualizarUI:",t)}}function criarOuAtualizarDonut(t,a,o,e,n){const r=document.getElementById(a);if(!r)return null;const i=[],s=[],l=[];e.forEach(((t,a)=>{t>0&&(i.push(t),s.push(o[a]),l.push(n[a]))})),0===i.length&&(i.push(1),s.push("Nenhum dado"),l.push("#3A3052"));const d={labels:s,datasets:[{data:i,backgroundColor:l,borderColor:"rgba(255,255,255,0)",borderWidth:0,hoverOffset:4}]},c={type:"doughnut",data:d,options:{responsive:!0,maintainAspectRatio:!0,cutout:"70%",plugins:{legend:{display:!0,position:"bottom",labels:{color:"#A09CB0",font:{family:"Poppins"},padding:10}},tooltip:{callbacks:{label:function(t){const a=t.label||"",o=t.raw||0,e=t.chart.data.datasets[0].data.reduce(((t,a)=>t+a),0),n=e>0?(o/e*100).toFixed(1):0;return"Nenhum dado"===a?"Nenhum dado":` ${a}: ${formatBRL(o)} (${n.replace(".",",")}%)`}}}}}};return t?(t.data=d,t.update(),t):new Chart(r,c)}function atualizarDonutCharts(t,a){pjDonutChart=criarOuAtualizarDonut(pjDonutChart,"pj-donut-chart",["Líquido no Bolso","Total de Custos/Impostos"],[t,a],["#0D47A1","#D32F2F"])}function atualizarAlturasAccordions(){document.querySelectorAll(".accordion-content").forEach((t=>{const a=t.previousElementSibling;a&&a.classList.contains("active")&&(t.style.maxHeight=t.scrollHeight+"px")}))}if("undefined"!=typeof window){const t=debounce(atualizarUI,300),a=atualizarUI;document.addEventListener("DOMContentLoaded",(()=>{["pj-faturamento","pj-rbt12","pj-atividade","pj-contabilidade","pj-outros"].forEach((o=>{const e=document.getElementById(o);if(e){const o="SELECT"===e.tagName?"change":"input";"input"===o?e.addEventListener(o,t):e.addEventListener(o,a)}})),document.querySelectorAll(".accordion-button").forEach((t=>{t.addEventListener("click",(()=>{t.classList.toggle("active");const a=t.nextElementSibling;a.style.maxHeight?a.style.maxHeight=null:a.style.maxHeight=a.scrollHeight+"px"}))}))})),window.addEventListener("load",(()=>{try{initAnimadores(),atualizarUI()}catch(t){console.error("Erro durante o window.onload:",t)}}))}